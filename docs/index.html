<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>mumosa: Multi-modal single-cell analyses</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">mumosa
   </div>
   <div id="projectbrief">Multi-modal analyses of single-cell data</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Multi-modal single-cell analyses </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__2github_2workspace_2README"></a> <img src="https://github.com/libscran/mumosa/actions/workflows/run-tests.yaml/badge.svg" alt="Unit tests" style="pointer-events: none;" class="inline"/> <img src="https://github.com/libscran/mumosa/actions/workflows/doxygenate.yaml/badge.svg" alt="Documentation" style="pointer-events: none;" class="inline"/> <a href="https://codecov.io/gh/libscran/mumosa"><img src="https://codecov.io/gh/libscran/mumosa/graph/badge.svg?token=6lt7ykKjoH" alt="Codecov" style="pointer-events: none;" class="inline"/></a></p>
<h1>Overview</h1>
<p>Multi-modal single-cell experiments generate data of different modalities (e.g., RNA, protein) from the same set of cells. In some parts of the analysis, we want to combine data from different modalities to increase the information available for each cell. This is most relevant to results that are expressed in terms of cells, like clustering and visualization with t-SNE or UMAP. A simple combining strategy is to just concatenate the per-modality data matrices together into a single matrix for further analysis. While convenient and compatible with many downstream procedures, this is complicated by the differences in the variance between modalities - higher noise in one modality might drown out biological signal in another modality that has lower variance.</p>
<p>In <b>mumosa</b>, we scale embeddings to equalize noise across modalities prior to concatenation. First, we compute the median distance to the $k$-th nearest neighbor in the low-dimensional embedding for each modality (e.g., after PCA). This distance is used as a proxy for the modality-specific noise within a subpopulation containing at least $k$ cells. We define a scaling factor for each modality as the ratio of the median distances for that modality compared to a "reference" modality. We scale the modality's embedding by its factor, removing differences in variance due to irrelevant factors like the scale of expression values, number of features, etc. We then concatenate the matrices to form a single embedding for further analysis.</p>
<p>We deliberately use the distance to the nearest neighbors instead of the total variance for each embedding. The latter would unnecessarily penalize modalities with strong biological heterogeneity. Our approach aims to remove differences in the magnitude of noise while preserving modality-specific biological signal in the concatenation.</p>
<h1>Quick start</h1>
<p>Given the embedding coordinates for multiple modalities, we compute the median distance to the $k$-nearest neighbor for each modality:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="mumosa_8hpp.html">mumosa/mumosa.hpp</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Mocking up some modalities.</span></div>
<div class="line"><span class="keywordtype">int</span> nobs = 1000;</div>
<div class="line">std::vector&lt;int&gt; dimensions(3, 20);</div>
<div class="line">std::vector&lt;std::vector&lt;double&gt; &gt; embeddings(3);</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> m = 0; m &lt; 3; ++m) {</div>
<div class="line">    embeddings[m].resize(nobs * dimensions[m]);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Computing distances per modality.</span></div>
<div class="line"><a class="code hl_struct" href="structmumosa_1_1Options.html">mumosa::Options</a> opt;</div>
<div class="line">opt.<a class="code hl_variable" href="structmumosa_1_1Options.html#a76621d12b7ed8b1c072ccf3598761640">num_neighbors</a> = 20;</div>
<div class="line">opt.<a class="code hl_variable" href="structmumosa_1_1Options.html#a390a953ace5a6fa0a172efb8cb691929">num_threads</a> = 3;</div>
<div class="line"> </div>
<div class="line">std::vector&lt;std::pair&lt;double, double&gt; &gt; distances;</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> m = 0; m &lt; 3; ++m) {</div>
<div class="line">    distances[m] = <a class="code hl_function" href="namespacemumosa.html#a1dd47f25008fcc2d8c1249761a03b466">mumosa::compute_distance</a>(</div>
<div class="line">        dimensions[m],</div>
<div class="line">        nobs,</div>
<div class="line">        embeddings[m].data(),</div>
<div class="line">        <a class="code hl_classRef" href="https://knncolle.github.io/knncolle/classknncolle_1_1VptreeBuilder.html">knncolle::VptreeBuilder&lt;&gt;</a>(), <span class="comment">// any NN algorithm can be used here.</span></div>
<div class="line">        opt</div>
<div class="line">    );</div>
<div class="line">}</div>
<div class="ttc" id="aclassknncolle_1_1VptreeBuilder_html"><div class="ttname"><a href="https://knncolle.github.io/knncolle/classknncolle_1_1VptreeBuilder.html">knncolle::VptreeBuilder</a></div></div>
<div class="ttc" id="amumosa_8hpp_html"><div class="ttname"><a href="mumosa_8hpp.html">mumosa.hpp</a></div><div class="ttdoc">Scale multi-modal embeddings based on their relative variance.</div></div>
<div class="ttc" id="anamespacemumosa_html_a1dd47f25008fcc2d8c1249761a03b466"><div class="ttname"><a href="namespacemumosa.html#a1dd47f25008fcc2d8c1249761a03b466">mumosa::compute_distance</a></div><div class="ttdeci">std::pair&lt; Float_, Float_ &gt; compute_distance(Index_ num_cells, Float_ *distances)</div><div class="ttdef"><b>Definition</b> mumosa.hpp:54</div></div>
<div class="ttc" id="astructmumosa_1_1Options_html"><div class="ttname"><a href="structmumosa_1_1Options.html">mumosa::Options</a></div><div class="ttdoc">Options for compute_distance().</div><div class="ttdef"><b>Definition</b> mumosa.hpp:27</div></div>
<div class="ttc" id="astructmumosa_1_1Options_html_a390a953ace5a6fa0a172efb8cb691929"><div class="ttname"><a href="structmumosa_1_1Options.html#a390a953ace5a6fa0a172efb8cb691929">mumosa::Options::num_threads</a></div><div class="ttdeci">int num_threads</div><div class="ttdef"><b>Definition</b> mumosa.hpp:37</div></div>
<div class="ttc" id="astructmumosa_1_1Options_html_a76621d12b7ed8b1c072ccf3598761640"><div class="ttname"><a href="structmumosa_1_1Options.html#a76621d12b7ed8b1c072ccf3598761640">mumosa::Options::num_neighbors</a></div><div class="ttdeci">int num_neighbors</div><div class="ttdef"><b>Definition</b> mumosa.hpp:32</div></div>
</div><!-- fragment --><p>We can then compute scaling factors for each modality:</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> scale = <a class="code hl_function" href="namespacemumosa.html#a889cc7f4d99446e2a7dcd1d398763ace">mumosa::compute_scale</a>(distances);</div>
<div class="ttc" id="anamespacemumosa_html_a889cc7f4d99446e2a7dcd1d398763ace"><div class="ttname"><a href="namespacemumosa.html#a889cc7f4d99446e2a7dcd1d398763ace">mumosa::compute_scale</a></div><div class="ttdeci">Float_ compute_scale(const std::pair&lt; Float_, Float_ &gt; &amp;ref, const std::pair&lt; Float_, Float_ &gt; &amp;target)</div><div class="ttdef"><b>Definition</b> mumosa.hpp:143</div></div>
</div><!-- fragment --><p>And use them to combine the embeddings into a single matrix:</p>
<div class="fragment"><div class="line"><span class="keywordtype">size_t</span> ntotal = std::accumulate(dimensions.begin(), dimensions.end(), 0);</div>
<div class="line">std::vector&lt;double&gt; combined(ntotal * nobs);</div>
<div class="line"> </div>
<div class="line">std::vector&lt;const double*&gt; inputs;</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; em : embeddings) {</div>
<div class="line">    inputs.push_back(em.data());</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="namespacemumosa.html#a5abe395d9107cd90aa10bba4362f847c">mumosa::combine_scaled_embeddings</a>(</div>
<div class="line">    dimensions,</div>
<div class="line">    nobs,</div>
<div class="line">    inputs,</div>
<div class="line">    scale,</div>
<div class="line">    combined.data()</div>
<div class="line">);</div>
<div class="ttc" id="anamespacemumosa_html_a5abe395d9107cd90aa10bba4362f847c"><div class="ttname"><a href="namespacemumosa.html#a5abe395d9107cd90aa10bba4362f847c">mumosa::combine_scaled_embeddings</a></div><div class="ttdeci">void combine_scaled_embeddings(const std::vector&lt; Dim_ &gt; &amp;num_dims, Index_ num_cells, const std::vector&lt; Input_ * &gt; &amp;embeddings, const std::vector&lt; Scale_ &gt; &amp;scaling, Output_ *output)</div><div class="ttdef"><b>Definition</b> mumosa.hpp:219</div></div>
</div><!-- fragment --><p>Check out the <a href="https://libscran.github.io/mumosa">reference documentation</a> for more details.</p>
<h1>Building projects</h1>
<h2>CMake with <code>FetchContent</code></h2>
<p>If you're using CMake, you just need to add something like this to your <code>CMakeLists.txt</code>:</p>
<div class="fragment"><div class="line">include(FetchContent)</div>
<div class="line"> </div>
<div class="line">FetchContent_Declare(</div>
<div class="line">  mumosa</div>
<div class="line">  GIT_REPOSITORY https://github.com/libscran/mumosa</div>
<div class="line">  GIT_TAG master # or any version of interest</div>
<div class="line">)</div>
<div class="line"> </div>
<div class="line">FetchContent_MakeAvailable(mumosa)</div>
</div><!-- fragment --><p>Then you can link to <b>mumosa</b> to make the headers available during compilation:</p>
<div class="fragment"><div class="line"># For executables:</div>
<div class="line">target_link_libraries(myexe libscran::mumosa)</div>
<div class="line"> </div>
<div class="line"># For libaries</div>
<div class="line">target_link_libraries(mylib INTERFACE libscran::mumosa)</div>
</div><!-- fragment --><h2>CMake with <code>find_package()</code></h2>
<div class="fragment"><div class="line">find_package(libscran_mumosa CONFIG REQUIRED)</div>
<div class="line">target_link_libraries(mylib INTERFACE libscran::mumosa)</div>
</div><!-- fragment --><p>To install the library, use:</p>
<div class="fragment"><div class="line">mkdir build &amp;&amp; cd build</div>
<div class="line">cmake .. -DNENESUB_TESTS=OFF</div>
<div class="line">cmake --build . --target install</div>
</div><!-- fragment --><p>By default, this will use <code>FetchContent</code> to fetch all external dependencies. If you want to install them manually, use <code>-DNENESUB_FETCH_EXTERN=OFF</code>. See the tags in <a href="extern/CMakeLists.txt"><code>extern/CMakeLists.txt</code></a> to find compatible versions of each dependency.</p>
<h2>Manual</h2>
<p>If you're not using CMake, the simple approach is to just copy the files in <code>include/</code> - either directly or with Git submodules - and include their path during compilation with, e.g., GCC's <code>-I</code>. This requires the external dependencies listed in <a href="extern/CMakeLists.txt"><code>extern/CMakeLists.txt</code></a>, which also need to be made available during compilation. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
